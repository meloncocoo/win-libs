name: Build Windows App

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        target: x86_64-pc-windows-msvc
    
    - name: Install MySQL Connector/C
      run: |
        # 下载 MySQL Connector/C
        Invoke-WebRequest -Uri "https://dev.mysql.com/get/Downloads/Connector-C/mysql-connector-c-6.1.11-winx64.zip" -OutFile "mysql.zip"
        Expand-Archive mysql.zip -DestinationPath "mysql"
        
        # 设置环境变量
        echo "LIB=C:\mysql\lib" >> $env:GITHUB_ENV
        echo "INCLUDE=C:\mysql\include" >> $env:GITHUB_ENV
        echo "PATH=C:\mysql\bin;$env:PATH" >> $env:GITHUB_ENV
    
    - name: Install dependencies
      run: npm install
    
    - name: Build Tauri app
      run: npm run tauri build
      env:
        RUST_BACKTRACE: 1
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: windows-app
        path: src-tauri/target/x86_64-pc-windows-msvc/release/bundle/
